<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">

    <title>gz6cook</title>
    
    <script src="https://unpkg.com/@isomorphic-git/lightning-fs"></script>
    <script src="https://unpkg.com/isomorphic-git"></script>
    <script type="module">
        import http from 'https://unpkg.com/isomorphic-git/http/web/index.js'
        window.http = http
    
        window.fs = new LightningFS('fs' /* , {wipe: true} */ )
        window.pfs = window.fs.promises
    
        window.git_ref = "git-notes" // "main"
    
        window.dir = '/tutorial';
        window.author = {
            name: 'gz6cook',
        }
     </script>

    <style>
        #fileTextEdit {
            height: calc(75vh);
        }
    </style>

    <script src="./js/NoSleep.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/css/bootstrap4-toggle.min.css" rel="stylesheet">

  </head>
  <body onload="init()">

    <header class="p-3 mb-3 border-bottom bg-dark">
        <div class="container">
          <div class="d-flex flex-wrap align-items-center justify-content-between">
            <ul class="nav mb-2">
              <li><a href="/" class="nav-link px-2 link-secondary">Home</a></li>
            </ul>
    
            <div>
              <input type="checkbox" data-toggle="toggle" data-on="Screen&nbsp;On" data-off="Screen&nbsp;Auto" class="mb-2" id="toggle" value="lock" />
            </div>
          </div>
        </div>
    </header>
    
    <div class="container-fluid">
        <label id="fileTextEditLabel" for="fileTextEdit">...</label>
        <textarea class="form-control" id="fileTextEdit" rows="12">...</textarea>
    </div>

    <!--
    <button onclick="editTest()">edit test.txt</button>

    <button onclick="pushAll()">push</button>
    token: <input type="text" id="github_token" name="github_token" /> 
    
    -->

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.6/dist/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>

  </body>

  <script>
    var noSleep = new NoSleep();
    var wakeLockEnabled = false;   
    $("#toggle").on('change', function() {
      if (!wakeLockEnabled) {
        noSleep.enable(); // keep the screen on!
        wakeLockEnabled = true;
      } else {
        noSleep.disable(); // let the screen turn off.
        wakeLockEnabled = false;
      }
    });

  </script>

  <script>

    async function init() {
    
        let searchParams = new URLSearchParams(window.location.search)
        let fname = searchParams.get('f')

        let txt = await pfs.readFile(dir + '/files/' + fname, { encoding: 'utf8' })
        $("#fileTextEditLabel").text(fname)
        $("#fileTextEdit").text(txt)

    }
    
    async function editTest() {
        await pfs.readFile(dir + '/files/test.txt', { encoding: 'utf8' }).then(console.log)    
        await pfs.writeFile(dir + '/files/test.txt', '' + Date.now())    
        await pfs.readFile(dir + '/files/test.txt', { encoding: 'utf8' }).then(console.log)    
        await refreshList()
    }
    
    async function pushAll() {
    
        await git.add({fs, dir, filepath: 'files/test.txt'})
        
        await git.commit({
            fs,
            dir: window.dir,
            author: window.author,
            message: 'update'
        }).then(console.log)
    
        await git.push({
            fs,
            http,
            dir: window.dir,
            remote: 'origin',
            ref: window.git_ref,
            onAuth: () => (                
                { 
                    // GitHub uses token as username
                    username: document.getElementById("github_token").value
                }
            ),
        }).then(console.log)
    
        await refreshList()
    }
    
    </script>    

</html>
