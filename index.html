<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">

    <title>gz6cook</title>
    
    <script src="https://unpkg.com/@isomorphic-git/lightning-fs"></script>
    <script src="https://unpkg.com/isomorphic-git"></script>
    <script type="module">
        import http from 'https://unpkg.com/isomorphic-git/http/web/index.js'
        window.http = http
    
        window.fs = new LightningFS('fs' /* , {wipe: true} */ )
        window.pfs = window.fs.promises
    
        window.git_ref = "git-notes" // "main"
    
        window.dir = '/tutorial';
        window.author = {
            name: 'gz6cook',
        }
     </script>

  </head>
  <body onload="init()">

    <header class="p-3 mb-3 border-bottom bg-dark">
        <div class="container">
          <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
            <!--a href="/" class="d-flex align-items-center mb-2 mb-lg-0 link-body-emphasis text-decoration-none">
              <svg class="bi me-2" width="40" height="32" role="img" aria-label="Bootstrap"><use xlink:href="#bootstrap"></use></svg>
            </a-->
    
            <ul class="nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0">
              <li><a href="#" class="nav-link px-2 link-secondary">Home</a></li>
              <!-- li><a href="#" class="nav-link px-2 link-body-emphasis">Inventory</a></li -->
            </ul>
    
            <!-- form class="col-12 col-lg-auto mb-3 mb-lg-0 me-lg-3" role="search">
              <input type="search" class="form-control" placeholder="Search..." aria-label="Search">
            </form -->
    
          </div>
        </div>
    </header>
    
    <div class="container">
        <div class="list-group" id="file_list" name="file_list"></div>
    </div>

    <!--
    <button onclick="editTest()">edit test.txt</button>

    <button onclick="pushAll()">push</button>
    token: <input type="text" id="github_token" name="github_token" /> 
    
    -->

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.6/dist/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

  </body>

  <script>

    async function init() {
    
        try {
            let dir_stat = await pfs.stat(dir);
        } catch (err) {
            
            console.log("clone")
            
            await pfs.mkdir(dir);
    
            await git.clone({
                fs,
                http,
                dir,
                corsProxy: 'https://cors.isomorphic-git.org',
                url: 'https://github.com/gz6cook/gz6cook.github.io.git',
                ref: git_ref,
                singleBranch: true,
                depth: 1
            })
        }
    
        let confs = await git.getConfigAll({
            fs,
            dir: window.dir,
            path: "remote.origin.fetch"
        })
        console.log('remote.origin.fetch: ' + confs)
    
        await pfs.readFile(dir + '/.git/config', { encoding: 'utf8' }).then(console.log)
        await pfs.readFile(dir + '/files/test.txt', { encoding: 'utf8' }).then(console.log)
    
        console.log("fetch")
        
        await git.fetch({
            fs,
            http,
            dir: window.dir,
            corsProxy: 'https://cors.isomorphic-git.org',
            url: 'https://github.com/gz6cook/gz6cook.github.io.git',
            ref: window.git_ref,
            prune: true
        })
    
        console.log("checkout")
        await git.checkout({
            fs,
            dir: window.dir,
            force: true,
            filepaths: ['files']
        })
    
        console.log("merge")
        await git.merge({
            fs,
            dir: window.dir,
            // ours: 'window.git_ref',
            theirs: 'remotes/origin/' + window.git_ref,
            author: window.author
        })
    
        await pfs.readFile(dir + '/files/test.txt', { encoding: 'utf8' }).then(console.log)
    
        await refreshList()
    }
    
    async function refreshList()
    {
        files = await pfs.readdir(dir + '/files')
        
        // clear list:
        var file_list = document.getElementById('file_list');
        while (file_list.firstChild) {
            file_list.removeChild(file_list.firstChild);
        }
    
        files.forEach(pageAppend);
    }
    
    async function pageAppend(value, index, array) {
        // console.log(value)
    
        let status = await git.status({ fs, dir: '/tutorial', filepath: 'files/' + value })
    
        // var file_list = document.getElementById('file_list');
        
        // var entry = document.createElement('a');
        
        // entry.appendChild(document.createTextNode(value));
        // entry.setAttribute('href', '#')
        // entry.setAttribute('class', 'list-group-item list-group-item-action')
    
        // var entry_status = document.createElement('span');
        // entry_status.appendChild(document.createTextNode(status));
        // entry_status.setAttribute('class', 'badge text-bg-primary rounded-pill')
        // entry.appendChild(entry_status);
    
        // file_list.appendChild(entry);

        $('#file_list').append($('<a>')
            .attr("href", "files/" + value)
            .addClass("list-group-item")
            .addClass("list-group-item-action")
            .append($("<div class='d-flex w-100 justify-content-between'>")
                .append($("<h5 class='mb-1'>")
                    .text(value)
                )
                .append($("<small>")
                    .text(status)
                )
            )
            // .append($('<p class="mb-1">Some placeholder content in a paragraph.</p>'))
            // .append($('<small>And some small print.</small>'))
        )
    }

    async function editTest() {
        await pfs.readFile(dir + '/files/test.txt', { encoding: 'utf8' }).then(console.log)    
        await pfs.writeFile(dir + '/files/test.txt', '' + Date.now())    
        await pfs.readFile(dir + '/files/test.txt', { encoding: 'utf8' }).then(console.log)    
        await refreshList()
    }
    
    async function pushAll() {
    
        await git.add({fs, dir, filepath: 'files/test.txt'})
        
        await git.commit({
            fs,
            dir: window.dir,
            author: window.author,
            message: 'update'
        }).then(console.log)
    
        await git.push({
            fs,
            http,
            dir: window.dir,
            remote: 'origin',
            ref: window.git_ref,
            onAuth: () => (                
                { 
                    // GitHub uses token as username
                    username: document.getElementById("github_token").value
                }
            ),
        }).then(console.log)
    
        await refreshList()
    }
    
    </script>    

</html>
