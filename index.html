<!DOCTYPE html>
<html>
<head>
<script src="https://unpkg.com/@isomorphic-git/lightning-fs"></script>
<script src="https://unpkg.com/isomorphic-git"></script>
<script type="module">
    import http from 'https://unpkg.com/isomorphic-git/http/web/index.js'
    window.http = http

    window.fs = new LightningFS('fs', {wipe: true})
    window.pfs = window.fs.promises
    window.dir = '/tutorial'

    window.git_ref = "git-notes" // "main"

    await pfs.mkdir(dir);
</script>

</head>
<body onload="init()">
    github_token: <input type="text" id="github_token" name="github_token" />
    <br><button onclick="pushAll()">Push</button>

    <ul id="file_list" name="file_list">&nbsp;</ul>

    <br><button onclick="editTest()">edit test.txt</button>
</body>

<script>

async function init() {
    await git.clone({
        fs,
        http,
        dir,
        corsProxy: 'https://cors.isomorphic-git.org',
        url: 'https://github.com/gz6cook/gz6cook.github.io.git',
        ref: git_ref,
        singleBranch: true,
        depth: 1
    }).then(console.log)

    files = await pfs.readdir(dir + '/files')

    files.forEach(pageAppend);
}

async function pageAppend(value, index, array) {
    // console.log(value)

    let status = await git.status({ fs, dir: '/tutorial', filepath: 'files/' + value })

    var file_list = document.getElementById('file_list');
    var entry = document.createElement('li');
    entry.appendChild(document.createTextNode(value + ", " + status));
    file_list.appendChild(entry);
}    

async function editTest() {
    // await pfs.readFile(dir + '/files/test.txt', { encoding: 'utf8' }).then(console.log)    
    await pfs.writeFile(dir + '/files/test.txt', '' + Date.now())    
    await pfs.readFile(dir + '/files/test.txt', { encoding: 'utf8' }).then(console.log)    
    await git.add({fs, dir, filepath: 'files/test.txt'})
}

async function pushAll() {

    await git.commit({
        fs,
        dir: window.dir,
        author: {
            name: 'gz6cook',
        },
        message: 'test update'
    }).then(console.log)

    await git.push({
        fs,
        http,
        dir: window.dir,
        remote: 'origin',
        ref: window.git_ref,
        onAuth: () => (                
            { 
                // GitHub uses token as username
                username: document.getElementById("github_token").value
            }
        ),
    }).then(console.log())
}

</script>    
</html>
