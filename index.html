<!DOCTYPE html>
<html>
<head>

<style>
    ul li {
        display: flex;
        justify-content: space-between;
    }
    
    ul li span {
        display: inline-block;
    }
    
    ul li .text {
        text-align: left;
    }
    
    ul li .right-aligned {
        text-align: right;
    }
    </style>

<script src="https://unpkg.com/@isomorphic-git/lightning-fs"></script>
<script src="https://unpkg.com/isomorphic-git"></script>
<script type="module">
    import http from 'https://unpkg.com/isomorphic-git/http/web/index.js'
    window.http = http

    window.fs = new LightningFS('fs' /* , {wipe: true} */ )
    window.pfs = window.fs.promises

    window.git_ref = "git-notes" // "main"

    window.dir = '/tutorial';
    window.author = {
        name: 'gz6cook',
    }
 </script>

</head>
<body onload="init()">
    <ul id="file_list" name="file_list">&nbsp;</ul>

    <button onclick="editTest()">edit test.txt</button>
    <br>
    <br>
    
    <button onclick="pushAll()">push</button>
    token: <input type="text" id="github_token" name="github_token" /> 
    

</body>

<script>

async function init() {

    try {
        let dir_stat = await pfs.stat(dir);
    } catch (err) {
        
        console.log("clone")
        
        await pfs.mkdir(dir);

        await git.clone({
            fs,
            http,
            dir,
            corsProxy: 'https://cors.isomorphic-git.org',
            url: 'https://github.com/gz6cook/gz6cook.github.io.git',
            ref: git_ref,
            singleBranch: true,
            depth: 1
        })

        // let confs = await getConfigAll({
        //     fs,
        //     dir: window.dir,
        //     path: ""
        // })
        // console.log(confs)


    }

    await pfs.readFile(dir + '/.git/config', { encoding: 'utf8' }).then(console.log)

    console.log("fetch")
    
    await git.fetch({
        fs,
        http,
        dir: window.dir,
        corsProxy: 'https://cors.isomorphic-git.org',
        url: 'https://github.com/gz6cook/gz6cook.github.io.git',
        ref: git_ref,
        prune: true
    })

    console.log("checkout")
    await git.checkout({
        fs,
        dir: window.dir,
        noUpdateHead: true,
        force: true
    })

    await refreshList()
}

async function refreshList()
{
    files = await pfs.readdir(dir + '/files')
    
    // clear list:
    var file_list = document.getElementById('file_list');
    while (file_list.firstChild) {
        file_list.removeChild(file_list.firstChild);
    }

    files.forEach(pageAppend);
}

async function pageAppend(value, index, array) {
    // console.log(value)

    let status = await git.status({ fs, dir: '/tutorial', filepath: 'files/' + value })

    var file_list = document.getElementById('file_list');
    
    var entry = document.createElement('li');
    
    var entry_text = document.createElement('span');
    entry_text.appendChild(document.createTextNode(value));
    entry_text.setAttribute('class', 'text')
    entry.appendChild(entry_text);

    var entry_status = document.createElement('span');
    entry_status.appendChild(document.createTextNode(status));
    entry_status.setAttribute('class', 'right-aligned')
    entry.appendChild(entry_status);

    file_list.appendChild(entry);
}    

async function editTest() {
    await pfs.readFile(dir + '/files/test.txt', { encoding: 'utf8' }).then(console.log)    
    await pfs.writeFile(dir + '/files/test.txt', '' + Date.now())    
    await pfs.readFile(dir + '/files/test.txt', { encoding: 'utf8' }).then(console.log)    
    await git.add({fs, dir, filepath: 'files/test.txt'})
    await refreshList()
}

async function pushAll() {

    await git.commit({
        fs,
        dir: window.dir,
        author: window.author,
        message: 'update'
    }).then(console.log)

    await git.push({
        fs,
        http,
        dir: window.dir,
        remote: 'origin',
        ref: window.git_ref,
        onAuth: () => (                
            { 
                // GitHub uses token as username
                username: document.getElementById("github_token").value
            }
        ),
    }).then(console.log)

    await refreshList()
}

</script>    
</html>
